# Анализ данных финансового сервиса 
Есть некоторый финансовый сервис, который агрегирует информацию из разных банков. Он производит всевозможную аналитику этих данных, формирует отчеты и витрины данных.

На основе данных, предоставленных финансовым сервисом необходимо было выполнить следующие задания:


### 1. Топовые mcc-группы. 
MCC (Merchant category code) - номер, который показывает вид продукции, которую продает торговая точка по банковской карте.
Необходимо рассчитать mcc-группы, по которым было больше всего транзакций в 2019 году. Расчет необходимо произвести за каждый месяц в отдельности.

В результате необходимо вывести столбцы:

- group_name - имя группы
- month - месяц
- tr_sum - сумму транзакций
- abs_diff - абсолютную разницу со вторым местом по сумме транзакций
- rel_diff - относительную разницу со вторым местом по сумме транзакций

Дополнительные условия:

- Если в каком-то месяце нет ни одно заказа, то указать null для всех столбцов (кроме month).
- Если в каком-то месяце заказы были только по одной mcc-группе, то абсолютную/относительную разницу указать как null.
- Если в каком-то месяце сумма транзакций совпадает для нескольких групп, то ранжирование происходит по лексикографическому признаку.
- Все суммы округлить до 2 знака после запятой.
- Результат должен быть отсортирован по возрастанию месяца - от 1 к 12.

Пример результирующей таблицы:

| group_name | month | tr_sum  | abs_diff | rel_diff |
|------------|-------|---------|----------|----------|
| ЖКХ        | 1     | 200.00  | 0.00     | 0.00     |
| Аптека     | 2     | 300.00  | 0.00     | 0.00     |
| null       | 3     | null    | null     | null     |
| null       | 4     | null    | null     | null     |
| Видеоигры  | 5     | 100.00  | 0.00     | 0.00     |
| ЖКХ        | 6     | 20.00   | 10.00    | 0.50     |
| ...... | ...... | ...... | ...... | ...... |


### 2. Самые дорогие транзакции.

Необходимо для каждой mcc-группы вывести 3 наиболее дорогих транзакции за 2019 и 2020 год. Если в рамках какой-то mcc группы за год было менее 3 транзакций, то недостающие места должны быть дополнены null.

В результате необходимо вывести столбцы:

- group_name - имя группы
- year - год
- rn - ранг
- transaction_value - сумма транзакции

Результат должен быть отсортирован по имени группы, рангу и году по возрастанию всех полей. Все суммы округлить до 2 знака после запятой.

Пример результирующей таблицы:

|group_name | year |rn |transaction_value|
|-----------|------|---|-----------------|
| АЗС       | 2019 | 1 | null    |
| АЗС       | 2020 | 1 | 1200.00 |
| АЗС       | 2019 | 2 | null    |
| АЗС       | 2020 | 2 | 300.00  |
| АЗС       | 2019 | 3 | null    |
| АЗС       | 2020 | 3 | 200.00  |
| Аптека    | 2019 | 1 | 300.00  |
| Аптека    | 2020 | 1 | 300.00  |
| Аптека    | 2019 | 2 | null    |
| Аптека    | 2020 | 2 | null    |
| Аптека    | 2019 | 3 | null    |
| Аптека    | 2020 | 3 | null    |
| ...... | ...... | ...... | ...... |


### Описание таблиц в БД merchant и пояснения к БД:

В этой базе описаны таблицы:

- mcc_groups - группы mcc-кодов
- mcc_codes - mcc-коды
- purchases - покупки
- clients - клиенты
- client_passport_change_log - журнал изменения паспортов
- client_address_change_log - журнал изменения адресов

Cо временем группа mcc кода (поле group_id в таблице mcc_codes) может меняться, поэтому необходимо рассматривать группы в конкретный момент времени.

Например, пусть некая продажа была сделана 5 февраля 2021 и указан code1. В таблице mcc_codes для этого mcc_code_id есть 3 записи. Тогда в момент джоина необходимо не просто соединять по mcc_code_id, но еще добавить условие: дата продажи должна лежать в диапазоне действия строки кода.

Подразумевается, что диапазоны valid_from и valid_to не пересекаются друг с другом. В данном примере, допустим, что диапазоны для mcc_code_id = code1 в таблице mcc_codes описаны такие:

01.01.2000 - 31.12.2018 - в это время mcc код отвечал группе 2
01.01.2018 - 31.12.2021 - в это время mcc код отвечал группе 3
01.01.2022 - 31.12.2023 - в это время mcc код снова отвечал группе 2

Таким образом, необходимо выбрать только строку, в которой диапазон указан 01.01.2018 - 31.12.2021, потому что именно этот диапазон действия отвечает дате транзакции.
